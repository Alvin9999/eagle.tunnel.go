# ET 配置

虽然不同的ET实现版本支持的特性不尽相同，但它们的配置文件是相互兼容的，少量不支持的参数会被自动忽略不生效。你可以在不同版本间使用同一个配置文件，使它们可以很好地协同工作。例如使用ET Go作为服务端时，你可以同时使用ET Go、ET D或者ET DNC来作为客户端，而他们可以共用同一份配置。

## 主配置文件

所谓主配置文件就是启动ET必须给出的配置文件，其中记录了程序运行需要的基本参数，这些参数会在接下来的指南中有所涉及，也会在文末进行汇总。如基础使用教程中的`client.conf`或`server.conf`这两个文件，就是主配置文件。这个配置文件可以根据你的喜好创建于任何位置，叫做任何名字。只要它遵循本文所述参数规则，你就可以用`et <配置文件>`这个格式的命令启动ET。

```shell
et <config-file>
# 例如 et /etc/eagle-tunnel.d/client.conf
```

主配置文件遵循以下格式：

> \# 注释部分  
> 参数1=参数1的值  
> 参数2=参数2的值

每行一对键值对。\#表示注释，符号`#`以及其所在行接下来的内容都将被忽略

### 快捷命令

ET提供了几个默认的配置文件位置，你可以通过快捷命令调用它：

```shell
# 调用服务端默认脚本
et server
```

此命令对应的默认脚本有四个可选位置（程序会顺序查找）：  

1. ./server.conf
2. ./config/server.conf
3. ./eagle-tunnel.conf
4. /etc/eagle-tunnel.d/server.conf

```shell
# 调用客户端默认脚本
et client
```

此命令对应的默认脚本有三个可选位置（程序会顺序查找）：

1. ./server.conf
2. ./config/server.conf
3. ./eagle-tunnel.conf
4. /etc/eagle-tunnel.d/server.conf

### 主配置文件的省略

当执行过安装脚本`install.sh`之后，主配置文件参数是可以被省略的。当它被省略后，默认会加载文件`/etc/eagle-tunnel.d/client.conf`。

## 用户认证

ET提供简单轻量的用户认证，它分为服务端和客户端两个部分。

### 服务端

打开用户认证功能需要将主配置中`user-check`参数置为`on`。

> user-check=on

所有用户信息应该被保存在用户列表中。用户列表是一个文本文件，默认情况下，它的位置为主配置文件同目录下的`users.list`，比如`/etc/eagle-tunnel.d/users.list`。当这个文件不存在，你需要自行创建。

用户列表的格式如下所示：

> 用户名1:密码1:用户1的速度限制:用户1的类型

每行代表一个用户，由四个参数组成——[用户名]:[密码]:[限速]:[用户类型]。注意它们之间的`:`是一个半角符号，而不是全角的`：`。它们的含义如下：

参数|含义|可填项|当不填写时
---|---|---|---
用户名||任意字符|用户无效
密码||任意字符|用户无效
限速|当前用户的最高传输速度，单位为（KB/s）|任意大于0的整数|不限速
类型|表明当前账户属于私有账户还是共享账户|share/private（二选一）|私有账户（private）

账户类型|含义
---|---
私有账户|同时只允许一个IP登录使用
共享账户|对同时登录IP没有限制

> 用户类型的设计初衷是，当多人共用同一份ET服务时，有时会以AA制付费。但如果有人私下将账户分享给他人，这是对付费成员的不公平。限制多地同时登录能一定程度缓解这种风险。

这里有一个`users.list`示例：

```shell
eagle:ppp:100:share
wang:aaa
lan:ccc::private
```

示例中存在三个用户：

用户名|密码|限速|类型
---|---|---|---
eagle|ppp|100KB/s|共享
wang|aaa|无|私有
lan|ccc|无|私有

### 客户端

打开用户认证的功能需要设置主配置中的`user`参数，格式类似于`服务端`小节：

```shell
user=wang:aaa
# 用户名为wang，密码是aaa
```

> 当然，在客户端你也可以通过`wang:aaa:100`这样的方式来对用户进行限速。（虽然很少情况需要这么干）

### 备注

`root`作为保留账户名，被禁止使用（使用时会被忽略）

### 验证

可在客户端处执行以下指令证明用户认证是否成功配置：

```shell
et ask local auth
```

成功的返回应该类似下面的示例：

> AUTH OK with local user: [客户端使用的用户名]

## 代理模式

ET使用`proxy-status`参数来控制其代理模式。当其值为`enable`时，ET表现为普通的全局代理软件，所有DNS解析和流量转发都通过服务端进行。当其值为`smart`时，ET会有额外的智能分流特性，所谓智能分流分为两个部分——DNS智能解析和流量智能转发。

> proxy-status=smart

### DNS智能解析

当ET进行DNS解析时，首先会判断其被解析的域名是否处于`DNS智能解析白名单`中。

这个白名单的位置是`${config-dir}/whitelist_domain.txt`，默认情况下这个位置是主配置文件同目录的`whitelist_domain.txt`。它来自[SmartDNSDomainList](https://github.com/eaglexiang/SmartDNSDomainList)项目，并遵循[模板文件](https://github.com/eaglexiang/SmartDNSDomainList/raw/master/list.txt)中注释部分所述规则。

如果被解析的域名处于白名单中，则会使用服务端进行代理解析。如果没有，则会先在本地解析，然后判断其是否处于国内。如果不是处于国内，则重新使用代理进行解析。

这样做的好处是可以尽量使用国内服务最近的CDN。

### 流量智能转发

流量的智能转发则相对简单得多。每个数据包会根据目的IP所在地的不同而采用不同的转发策略。对于大陆IP，直接由客户端在本地进行转发。对于其它IP，则由服务端进行代理转发。

## hosts文件

hosts文件是网络活动中常用的规则文件。但全局代理状态下，hosts文件是不生效的。为弥补这一点，ET提供了对hosts文件的支持。用户只需要将hosts文件放置于配置文件目录中hosts文件夹（例如`/etc/eagle-tunnel.d/hosts/`）内，ET便会在启动时自动加载它。

所有以`.hosts`为后缀的文件都将被加载。

> ET默认使用了neoHosts项目提供的广告屏蔽hosts，如果你不喜欢可以自由删去。

## 参数总览

这一小节所说的参数，指的是主配置文件中所使用的参数。ET目前拥有的参数，以及其解释会被放在下表：

参数名|值类型|示例|默认值|解释
---|---|---|---|---
relayer|IP地址:端口号|8.8.8.8:8080|空|上级relayer（服务端）的监听地址。对于客户端来讲它是必填项。当你只填写了IP地址（如8.8.8.8）它会被自动添上默认端口号（8080）
listen|IP地址：端口号|127.0.0.1:8080|0.0.0.0:8080|本地relayer（客户端）的监听地址。当你只填写了IP地址（如8.8.8.8）它会被自动添上默认端口号（8080）。当它的值为0.0.0.0::8080时，代表程序会监听本地所有IP地址的8080端口
http|on/off|on|off|HTTP代理协议的开关。当值为on时，程序会接收HTTP代理协议的流量。这个参数通常被用于客户端中
socks|on/off|on|off|SOCKS协议的开关。当值为on时，程序会接收SOCKS协议的流量。这个参数通常被用于客户端中
et|on/off|on|off|ET协议的开关。当值为on时，程序会接收ET协议的流量。这个参数通常被用于服务端中
user|用户名:密码|username:password|空|客户端使用的登录账户。当它为空时，表示关闭用户检查（这需要服务端同时关闭用户检查）。
user-check|on/off|on|off|服务端的用户检查开关，当它为on时，用户检查功能开启。所有被授权的用户应该被写在用户列表中。
proxy-status|enable/smart|smart|enable|代理服务的模式状态，这个参数只对客户端生效。当为enable时，为全局代理，当为smart时，为只能代理。
config-dir|文件路径名|/etc/eagle-tunnel.d|/etc/eagle-tunnel.d|次要配置文件所在目录。次要配置文件包括用户列表、需要智能DNS解析的域名列表等